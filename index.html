<!DOCTYPE html>
<html>
<head>
    <title>Visualized course reviews from USTSPACE</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script defer src="https://pyscript.net/releases/2024.1.1/core.js"></script>
</head>
<body>
    <py-script>
        course   = "PHYS1003"
        username = "cisuyanto"
        password = "07Fcandice14"
        theme    = "GnBu"
        
        #____________________________________________
        
        
        try:
            
            driver.get(f"https://ust.space/review/{course}")
            
        except:
            
            import warnings
            
            import numpy as np
            import pandas as pd
            import plotly.express as px
            import plotly.graph_objects as go
            
            import ipywidgets as widgets
            from ipywidgets import HBox, Label, Output, Dropdown, ToggleButtons
            
            from bs4 import BeautifulSoup
        
            from selenium import webdriver
            from selenium.webdriver.common.by import By
            from selenium.webdriver.common.keys import Keys
            from selenium.webdriver.support.ui import WebDriverWait
            from selenium.webdriver.support import expected_conditions as EC
            
            pd.set_option("display.max_columns", None)
            warnings.filterwarnings("ignore")
            course = course.replace(" ", "").upper()
        
            driver = webdriver.Chrome()
            driver.get(f"https://ust.space/review/{course}")
        
            def element (keyword, by = By.CSS_SELECTOR, driver_active = driver):
                return driver_active.find_element (by, keyword)
        
            def elements(keyword, by = By.CSS_SELECTOR, driver_active = driver):
                return driver_active.find_elements(by, keyword)
        
            element("input#username").send_keys(username)
            element("input#password").send_keys(password)
            element("button#login-btn").click()
        
        WebDriverWait(driver, 10).until(EC.all_of(
            EC.title_contains(f"{course[:4]} {course[4:]}"),
            EC.presence_of_element_located((By.CSS_SELECTOR, "div.course-review-record"))
        ))
        
        # Extract entire page source as a soup
        soup = BeautifulSoup(driver.page_source, "html.parser")
        
        max_record_len = 16
        max_instructors = 1
        review_records = []
        review_records_multiple = []
        
        dict_season = {"Fall": 1, "Winter": 2, "Spring": 3, "Summer": 4}
        sem_code = lambda sem: int(sem[2:4]) * 100 + dict_season[sem[8:]] * 10
        
        for review in soup.select("div.course-review-record"):
            
            # Retrieve: Semester with school year
            semester = review.select_one("p.semester").text
            review_record = [semester, sem_code(semester)]
            
            # Retrieve: Ratings × 4
            for rating in review.select("ul.rating-container>li>span"):
                review_record.append(rating.text)
                
            # Retrieve: Course components × 9
            components = {None: None}
            for item in review.select("div.course-review-record-content>ul>li"):
                icon = item.select_one("span.glyphicon").get("class")[1]
                is_true = True if icon == "glyphicon-ok" else False
                components.update({item.text: is_true})
            components.pop(None)
            for attribute, true_false in sorted(components.items()):
                review_record.append(true_false)
                
            # Retrieve: Instructors × n (variable)
            names = review.select("p.details>em")
            instructors = []
            for name in names:
                instructors.append(name.text)
                review_records.append([*review_record, name.text])
                
            # Update the maximum number of instructors mentioned in one review
            if  max_instructors < len(names):
                max_instructors = len(names)
                
            # Combine all data into one list
            review_records_multiple.append([*review_record, *instructors])
        
        def reviews(mode = 1):
            
            titles_single = ["Semester", "Semester Code", "Content", "Teaching",
                             "Grading", "Workload", *tuple(components.keys()), "Instructor"]
        
            titles_multiple = ["Semester", "Semester Code", "Content", "Teaching",
                               "Grading", "Workload", *tuple(components.keys()),
                               *["Instructor " + str(i + 1) for i in range(max_instructors)]]
            
            df = pd.DataFrame(review_records if mode == 1 else review_records_multiple,
                              columns = titles_single if mode == 1 else titles_multiple)
            
            return df.sort_values(by = "Semester Code", ascending = False).reset_index(drop = True)
        
        # reviews(1): Data provided from review_records (Only one instructor per record)
        # reviews(2): Data provided from review_records_multiple (Multiple instuctors)
        
        df_reviews = reviews(1)
        
        fig_title = {
            1 : f"Figure 1A: Average ratings for each year, {course[:4]} {course[4:]}.",
            2 : f"Figure 1B: Average ratings for each instructor, {course[:4]} {course[4:]}.",
            3 : f"Figure 1C: Average ratings for each semester, {course[:4]} {course[4:]}.",
            4 : f"Figure 1D: Average ratings for each season, {course[:4]} {course[4:]}.",
            5 : f"Figure 2A: Frequency of each component by year, {course[:4]} {course[4:]}.",
            6 : f"Figure 2B: Frequency of each component by instructor, {course[:4]} {course[4:]}.",
            7 : f"Figure 2C: Frequency of each component by semester, {course[:4]} {course[4:]}.",
            8 : f"Figure 2D: Frequency of each component by season, {course[:4]} {course[4:]}.",
            9 : f"Figure 3A: Average rating for content by instructor by year, {course[:4]} {course[4:]}.",
            10: f"Figure 3B: Average rating for teaching by instructor by year, {course[:4]} {course[4:]}.",
            11: f"Figure 3C: Average rating for grading by instructor by year, {course[:4]} {course[4:]}.",
            12: f"Figure 3D: Average rating for workload by instructor by year, {course[:4]} {course[4:]}.",
            13: f"Figure 4A: Average rating for content by instructor by semester, {course[:4]} {course[4:]}.",
            14: f"Figure 4B: Average rating for teaching by instructor by semester, {course[:4]} {course[4:]}.",
            15: f"Figure 4C: Average rating for grading by instructor by semester, {course[:4]} {course[4:]}.",
            16: f"Figure 4D: Average rating for workload by instructor by semester, {course[:4]} {course[4:]}.",
        }
        
        fig_options_tc = {
            1 : f"Figure 1A: 邊一年最好讀?",
            2 : f"Figure 1B: 邊個prof最好讀?",
            3 : f"Figure 1C: 邊個sem最好讀?",
            4 : f"Figure 1D: 邊一季最好讀?",
            5 : f"Figure 2A: 每年嘅考核模式係點?",
            6 : f"Figure 2B: 每個prof嘅考核模式係點?",
            7 : f"Figure 2C: 每個sem嘅考核模式係點?",
            8 : f"Figure 2D: 每一季嘅考核模式係點?",
            9 : f"Figure 3A: 每個prof每年教嘅內容好唔好?",
            10: f"Figure 3B: 每個prof每年教得好唔好?",
            11: f"Figure 3C: 每個prof每年俾grade靚唔靚?",
            12: f"Figure 3D: 每個prof每年workload多唔多?",
            13: f"Figure 4A: 每個prof每個sem教嘅內容好唔好?",
            14: f"Figure 4B: 每個prof每個sem教得好唔好?",
            15: f"Figure 4C: 每個prof每個sem俾grade靚唔靚?",
            16: f"Figure 4D: 每個prof每個sem workload多唔多?",
        }
        
        fig_options_en = {
            1 : f"Figure 1A: Which year is the best?",
            2 : f"Figure 1B: Which instructor is the best?",
            3 : f"Figure 1C: Which semester is the best?",
            4 : f"Figure 1D: Which season is the best?",
            5 : f"Figure 2A: How is the assessment done for each year?",
            6 : f"Figure 2B: How is the assessment done for each instructor?",
            7 : f"Figure 2C: How is the assessment done for each semester?",
            8 : f"Figure 2D: How is the assessment done for each season?",
            9 : f"Figure 3A: Is the content good for this instructor in this year?",
            10: f"Figure 3B: Is the teaching good for this instructor in this year?",
            11: f"Figure 3C: Is the grading good for this instructor in this year?",
            12: f"Figure 3D: Is the workload good for this instructor in this year?",
            13: f"Figure 4A: Is the content good for this instructor in this semester?",
            14: f"Figure 4B: Is the teaching good for this instructor in this semester?",
            15: f"Figure 4C: Is the grading good for this instructor in this semester?",
            16: f"Figure 4D: Is the workload good for this instructor in this semester?",
        }
        
        def all_except(*items, at = list(df_reviews.keys())):
            list_of_items = list(at)
            for item in items:
                list_of_items.remove(item)
            return list_of_items
        
        cols = ["Semester Code", "Content", "Teaching", "Grading", "Workload", "Instructor", "Semester"]
        to_score = {"A": 4, "B": 3, "C": 2, "D": 1, "E": 0}
        title_prefix = "Score_"
        
        df_temp = df_reviews[cols].copy()
        score_avg = {None: None}
        for col in cols[1:5]:
            title = title_prefix + col[0]
            df_temp[title] = df_temp[col].apply(lambda grade: to_score[grade])
            score_avg.update({title: "mean"})
        score_avg.pop(None)
        
        df_temp["School Year"] = df_temp["Semester"].apply(lambda sem: sem[:7])
        df_temp["Season"] = df_temp["Semester"].apply(lambda sem: sem[8:])
        
        name_criteria = "Criteria"
        name_scores = "Scores"
        
        to_grade = {           0: "E", 0.3: "E+",
                    0.7: "D-", 1: "D", 1.3: "D+",
                    1.7: "C-", 2: "C", 2.3: "C+",
                    2.7: "B-", 3: "B", 3.3: "B+",
                    3.7: "A-", 4: "A"}
        
        def df_by(by, sort_by = None, ascending = True, df = df_temp, melt = True):
            if sort_by is None:
                sort_by = by
            df = df.groupby(by
                  ).agg(score_avg
                  ).reset_index(drop = False
                  ).rename(columns = {title_prefix + col[0]: col for col in cols[1:5]}
                  ).sort_values(by = sort_by, ascending = ascending)
            if melt:
                df = df.melt(value_vars = cols[1:5],
                             id_vars = by, var_name = name_criteria, value_name = name_scores)
            return df
        
        def fig_of(df, by = None, scores = name_scores, criteria = name_criteria, h = 400):
            titles = list(df.keys())
            if by is None:
                by = titles[0]
            return px.line(df, x = by, y = scores, color = criteria,
                           markers = True).update_layout(height = h)
        
        def fig_by(df, title = "", h = 300, w = None):
            fig = go.Figure(data = go.Heatmap(colorscale = theme,
                            x = list(df.T.keys()), y = list(df.keys()), z = df.T,
                            colorbar = dict(
                                tickvals = [4, 3, 2, 1, 0],
                                ticktext = ["A", "B", "C", "D", "E"]
                            ))).update_layout(height = h, title = title)
            if w is not None:
                fig.update_layout(width = w)
            return fig
        
        def cga_of(df, sort_by = None, ascending = True, by = None, scores = name_scores, criteria = name_criteria):
            if by is None:
                by = list(df.keys())[0]
            if sort_by is None:
                sort_by = by
            return df.pivot_table(values = scores, index = by, columns = criteria
                    ).sort_values(by = sort_by, ascending = ascending
                    ).applymap(lambda x: to_grade[min(list(to_grade.keys()), key = lambda y: abs(y - x))])
        
        df_by_yr = df_by("School Year")
        fig_of_yr = fig_of(df_by_yr)
        fig_by_yr = fig_by(df_by("School Year", melt = False).set_index("School Year"), fig_title[1])
        cga_by_yr = cga_of(df_by_yr, ascending = False)
        
        df_by_ins = df_by("Instructor", "Teaching")
        fig_of_ins = fig_of(df_by_ins[df_by_ins["Instructor"] != "Not Specified"])
        fig_by_ins = fig_by(df_by("Instructor", "Teaching",
            melt = False)[df_by_ins["Instructor"] != "Not Specified"].set_index("Instructor"), fig_title[2])
        cga_by_ins = cga_of(df_by_ins, "Teaching", False)
        
        df_by_sem = pd.merge(df_reviews[["Semester", "Semester Code"]].drop_duplicates(),
            df_by("Semester Code"), how = "left", on = "Semester Code")
        fig_of_sem = fig_of(df_by_sem[all_except("Semester Code", at = df_by_sem.keys())])
        fig_by_sem = fig_by(pd.merge(df_reviews[["Semester", "Semester Code"]].drop_duplicates(),
            df_by("Semester Code", melt = False), how = "right", on = "Semester Code"
                )[["Semester", "Content", "Teaching", "Grading", "Workload"]].set_index("Semester"), fig_title[3])
        cga_by_sem = cga_of(df_by_sem, ascending = False)
        
        df_by_sea = df_by("Season")
        fig_of_sea = fig_of(df_by_sea)
        fig_by_sea = fig_by(df_by("Season", melt = False).set_index("Season"), fig_title[4])
        cga_by_sea = cga_of(df_by_sea, ascending = False)
        
        #fig_by_yr.show()
        #fig_by_ins.show()
        #fig_by_sem.show()
        #fig_by_sea.show()
        
        df_temp = df_reviews.copy()
        df_temp["School Year"] = df_temp["Semester"].apply(lambda sem: sem[:7])
        df_temp["Season"] = df_temp["Semester"].apply(lambda sem: sem[8:])
        
        def fig_on(by, title = "", h = 450, up = False, sort_twice = False, left = False, dropna_keyword = None, w = None):
            df_comp = df_temp.groupby(by).agg({title: "mean" for title in sorted(components.keys())}).T
            if dropna_keyword is not None:
                df_comp = df_comp.drop(columns = [dropna_keyword])
            if up:
                df_comp = df_comp.iloc[df_comp.apply(sum, axis = 1).argsort()].T
            else:
                df_comp = df_comp.iloc[df_comp.apply(sum, axis = 1).argsort()[::-1]].T
            if sort_twice:
                if left:
                    df_comp = df_comp.iloc[df_comp.apply(sum, axis = 1).argsort()]
                else:
                    df_comp = df_comp.iloc[df_comp.apply(sum, axis = 1).argsort()[::-1]]
            fig = go.Figure(data = go.Heatmap(colorscale = theme,
                            x = list(df_comp.T.keys()), y = list(df_comp.keys()), z = df_comp.T,
                            colorbar = dict(
                                #title = f"Occurrence",
                                tickvals = [1, 0.75, 0.5, 0.25, 0],
                                ticktext = ["Always", "Often", "Sometimes", "Seldom", "Never"]
                            ))).update_layout(height = h, title = title)
            if w is not None:
                fig.update_layout(width = w)
            return fig
        
        fig_on_yr = fig_on("School Year", fig_title[5], 420, True)
        fig_on_ins = fig_on("Instructor", fig_title[6], 420, True, True, False, "Not Specified")
        fig_on_sem = fig_on("Semester", fig_title[7], 420, True)
        fig_on_sea = fig_on("Season", fig_title[8], 420, True)
        
        #fig_on_yr.show()
        #fig_on_ins.show()
        #fig_on_sem.show()
        #fig_on_sea.show()
        
        df_temp = df_reviews.copy()
        df_temp["School Year"] = df_temp["Semester"].apply(lambda sem: sem[:7])
        
        to_score = {"A": 4, "B": 3, "C": 2, "D": 1, "E": 0}
        title_prefix = "Score_"
        
        score_avg = {None: None}
        for col in cols[1:5]:
            title = title_prefix + col[0]
            df_temp[title] = df_temp[col].apply(lambda grade: to_score[grade])
            score_avg.update({title: "mean"})
        score_avg.pop(None)
        
        def fig_for(ctgw, by, title = "", df = df_temp):
            df_ins_sem = df.pivot_table(index = "Instructor",
                                        columns = by,
                                        values = title_prefix + ctgw,
                                        aggfunc = "mean")
        
            df_ins_sem = df_ins_sem[df_ins_sem.index != "Not Specified"]
            df_ins_sem = df_ins_sem.sort_values(by = list(reversed(df_ins_sem.keys())))
            df_ins_sem_easyreading = df_ins_sem.fillna(value = "")
        
            fig_ins_sem = go.Figure(data = go.Heatmap(colorscale = theme,
                                    x = list(df_ins_sem.keys()), y = list(df_ins_sem.T.keys()), z = df_ins_sem,
                                    colorbar = dict(
                                        tickvals = [4, 3, 2, 1, 0],
                                        ticktext = ["A", "B", "C", "D", "E"]
                                    ))).update_layout(plot_bgcolor = "#F8F8F8", title = title)
            
            return fig_ins_sem
            
        fig_ins_yr_C = fig_for("C", "School Year", fig_title[9])
        fig_ins_yr_T = fig_for("T", "School Year", fig_title[10])
        fig_ins_yr_G = fig_for("G", "School Year", fig_title[11])
        fig_ins_yr_W = fig_for("W", "School Year", fig_title[12])
        
        #fig_ins_yr_C.show()
        #fig_ins_yr_T.show()
        #fig_ins_yr_G.show()
        #fig_ins_yr_W.show()
        
        fig_ins_sem_C = fig_for("C", "Semester", fig_title[13])
        fig_ins_sem_T = fig_for("T", "Semester", fig_title[14])
        fig_ins_sem_G = fig_for("G", "Semester", fig_title[15])
        fig_ins_sem_W = fig_for("W", "Semester", fig_title[16])
        
        #fig_ins_sem_C.show()
        #fig_ins_sem_T.show()
        #fig_ins_sem_G.show()
        #fig_ins_sem_W.show()
        
        fig_name = {
            1 : fig_by_yr,        9 : fig_ins_yr_C,
            2 : fig_by_ins,       10: fig_ins_yr_T,
            3 : fig_by_sem,       11: fig_ins_yr_G,
            4 : fig_by_sea,       12: fig_ins_yr_W,
            5 : fig_on_yr,        13: fig_ins_sem_C,
            6 : fig_on_ins,       14: fig_ins_sem_T,
            7 : fig_on_sem,       15: fig_ins_sem_G,
            8 : fig_on_sea,       16: fig_ins_sem_W,
        }
        
        reverse_dict = lambda dictionary: {value: key for key, value in dictionary.items()}
        
        title_fig = reverse_dict(fig_title)
        options_en_fig = reverse_dict(fig_options_en)
        options_tc_fig = reverse_dict(fig_options_tc)
        
        label = Label(f"About {course[:4]} {course[4:]}, what questions would you like to ask?")
        dropdown = Dropdown(options = ["All", *list(fig_options_en.values())])
        language = ToggleButtons(options = ["廣東話 Menu", "English Menu"], value = "English Menu")
        graph_area = Output(layout = Layout(height = "1000px"))
        
        def on_dropdown_change(change):
            graph_area.clear_output()
            with graph_area:
                if dropdown.value == "All":
                    for i in list(sorted(fig_name.keys())):
                        fig_name[i].show()
                else:
                    options_fig = options_en_fig if language.value == "English Menu" else options_tc_fig
                    fig_name[options_fig[dropdown.value]].show()
        
        def on_language_change(change):
            if language.value == "廣東話 Menu":
                current_value = options_en_fig[dropdown.value]
                dropdown.options = ["All", *list(fig_options_tc.values())]
                dropdown.value = fig_options_tc[current_value]
                label.value = f"對於 {course[:4]} {course[4:]}, 你想詢問以下邊條問題?"
            elif language.value == "English Menu":
                current_value = options_tc_fig[dropdown.value]
                dropdown.options = ["All", *list(fig_options_en.values())]
                dropdown.value = fig_options_en[current_value]
                label.value = f"About {course[:4]} {course[4:]}, what questions would you like to ask?"
            else: pass
                
        dropdown.observe(on_dropdown_change, "value")
        language.observe(on_language_change, "value")
        
        display(label)
        display(HBox([dropdown, language]))
        display(graph_area)
        
        with graph_area:
            for i in list(sorted(fig_name.keys())):
                fig_name[i].show()
    </py-script>
    <div id="output-div"></div>
</body>
</html>
